<script>
    var active = false;

    function handleIconClick(tab)
    {
        if (tabIsChrome(tab)) {
            alert("You cannot use ChromePHP on this page.");
            return;
        }
        toggleDomain(tab);
    }

    function tabIsChrome(tab)
    {
        return tab.url.indexOf("https://chrome.google.com/extensions") == 0 || tab.url.indexOf("chrome://") == 0;
    }

    function toggleDomain(tab)
    {
        var url = tab.url;
        url = getTopLevelDomain(url);
        if (domainIsActive(url)) {
            localStorage[url] = false;
            deactivate();
            return;
        }
        localStorage[url] = true;
        activate();
    }

    function getTopLevelDomain(url)
    {
        var pattern = /^(https?:\/\/)/;
        url = url.replace(pattern, '', url);
        domain = url.split('/')[0];
        bits = domain.split('.');
        ext = bits.pop();
        domain = bits.pop();
        return domain + "." + ext;
    }

    function domainIsActive(url)
    {
        return localStorage[url] == "true";
    }

    function activate()
    {
        active = true;
        enableIcon();
    }

    function deactivate()
    {
        active = false;
        disableIcon();
    }

    function enableIcon()
    {
        chrome.browserAction.setIcon({path:"icon48.png"});
    }

    function disableIcon()
    {
        chrome.browserAction.setIcon({path:"icon48_disabled.png"});
    }

    function handleTabUpdate(tab_id)
    {
        chrome.tabs.get(tab_id, function (tab) {
            if (tabIsChrome(tab)) {
                deactivate();
                return;
            }
            domain = getTopLevelDomain(tab.url);
            if (domainIsActive(domain)) {
                activate();
                return;
            }
            deactivate();
        })
    }

    if (chrome.cookies) {
        chrome.cookies.onChanged.addListener(function(info) {
            chrome.tabs.getSelected(null, function(tab) {

                if (info.cookie.domain.indexOf(getTopLevelDomain(tab.url)) === -1) {
                    return;
                }

                chrome.tabs.sendRequest(tab.id, {name: "cookie_update", info: info});
            });
        });
    }

    chrome.browserAction.onClicked.addListener(handleIconClick);
    chrome.tabs.onSelectionChanged.addListener(handleTabUpdate);
    chrome.tabs.onUpdated.addListener(handleTabUpdate);
    chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
        if (request === "localStorage") {
            sendResponse(localStorage);
            return;
        }
        if (request === "isActive") {
            sendResponse(active);
            return;
        }
        if (request.name === "cookie") {
            details = {};
            details.url = request.url;
            details.name = request.cookie_name;
            chrome.cookies.get(details, function(cookie) {
                sendResponse(cookie);
            });
            return;
        }
        if (request.name === "eatCookie") {
            details = {};
            details.url = request.url;
            details.name = request.cookie_name;
            chrome.cookies.remove(details);
            sendResponse({removed : true});
        }
    });

</script>
